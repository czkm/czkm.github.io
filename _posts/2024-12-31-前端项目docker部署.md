---
layout:     post                    # ä½¿ç”¨çš„å¸ƒå±€ï¼ˆä¸éœ€è¦æ”¹ï¼‰
title:      å‰ç«¯é¡¹ç›®dockeréƒ¨ç½²       # æ ‡é¢˜ 
subtitle:   dockeréƒ¨ç½² #å‰¯æ ‡é¢˜
date:       2024-12-31            # æ—¶é—´
author:     czk                      # ä½œè€…
header-img: img/my/img21.jpg    #è¿™ç¯‡æ–‡ç« æ ‡é¢˜èƒŒæ™¯å›¾ç‰‡
catalog: true                       # æ˜¯å¦å½’æ¡£
tags:  
#æ ‡ç­¾
    - docker
    
---

## å†™åœ¨å‰é¢

### Dockerå¯¹æ¯”ä¼ ç»Ÿè™šæ‹Ÿæœº

| ç‰¹æ€§ |å®¹å™¨  |è™šæ‹Ÿ|
| --- | --- | --- |
| å¯åŠ¨ | ç§’çº§ | åˆ†é’Ÿçº§ |
| ç¡¬ç›˜ä½¿ç”¨ | ä¸€èˆ¬ä¸º `MB` | ä¸€èˆ¬ä¸º `GB` |
| æ€§èƒ½ | æ¥è¿‘åŸç”Ÿ | å¼±äº|
| ç³»ç»Ÿæ”¯æŒé‡ | å•æœºæ”¯æŒä¸Šåƒä¸ªå®¹å™¨ | ä¸€èˆ¬å‡ åä¸ª|

> [Docker](https://www.docker.com/) æ˜¯ä¸ªåˆ’æ—¶ä»£çš„å¼€æºé¡¹ç›®ï¼Œå®ƒå½»åº•é‡Šæ”¾äº†è®¡ç®—è™šæ‹ŸåŒ–çš„å¨åŠ›ï¼Œæå¤§æé«˜äº†åº”ç”¨çš„ç»´æŠ¤æ•ˆç‡ï¼Œé™ä½äº†äº‘è®¡ç®—åº”ç”¨å¼€å‘çš„æˆæœ¬ï¼ä½¿ç”¨ Dockerï¼Œå¯ä»¥è®©åº”ç”¨çš„éƒ¨ç½²ã€æµ‹è¯•å’Œåˆ†å‘éƒ½å˜å¾—å‰æ‰€æœªæœ‰çš„é«˜æ•ˆå’Œè½»æ¾ï¼
æ— è®ºæ˜¯åº”ç”¨å¼€å‘è€…ã€è¿ç»´äººå‘˜ã€è¿˜æ˜¯å…¶ä»–ä¿¡æ¯æŠ€æœ¯ä»ä¸šäººå‘˜ï¼Œéƒ½æœ‰å¿…è¦è®¤è¯†å’ŒæŒæ¡ Dockerï¼ŒèŠ‚çº¦æœ‰é™çš„ç”Ÿå‘½ã€‚

æ–‡ç« çš„ä¸»æ—¨é€šè¿‡è®©å¼€å‘è€…é€šè¿‡å°†ä¸€ä¸ªvueé¡¹ç›®è¿›è¡ŒDockeråŒ–,ä»¥è¾¾åˆ°å¯¹Dockerå­¦ä¹ ä½œç”¨,ä¸»è¦æµç¨‹å¦‚ä¸‹


- æ‰“åŒ…æ‰‹å¤´çš„ä¸€ä¸ªVueé¡¹ç›®ï¼Œç”Ÿæˆçš„`distæ–‡ä»¶å¤¹`,ç¼–å†™`Dockerfile`æ–‡ä»¶ é€šè¿‡dockeræ‰“åŒ…ç”Ÿæˆä¸€ä¸ª`å‰ç«¯é•œåƒ`ï¼Œç„¶åé€šè¿‡è¿™ä¸ª`å‰ç«¯é•œåƒ`å®ä¾‹åŒ–å¯åŠ¨ä¸€ä¸ª`å‰ç«¯å®¹å™¨` å®ç°å‰ç«¯é¡¹ç›®éƒ¨ç½²

- é…ç½®åç«¯ç¯å¢ƒ,æˆ–è€…å¯åŠ¨ä¸€ä¸ª`nodeæœåŠ¡`ï¼Œå®ç°ç®€å•æ¥å£ã€‚ä¹Ÿé€šè¿‡dockeræ‰“åŒ…ç”Ÿæˆä¸€ä¸ª`nodeæœåŠ¡é•œåƒ`ï¼Œè¿è¡Œä¸€ä¸ª`nodeserverå®¹å™¨`ï¼Œæä¾›åç«¯æ¥å£ å®ç°åç«¯æœåŠ¡éƒ¨ç½²

-  é€šè¿‡`nginx`ä»£ç†ï¼Œè®©å‰ç«¯æ¥å£çš„è¯·æ±‚è½¬å‘åˆ°`nodeserverå®¹å™¨`ä¸Š å®ç°`nginxä»£ç†è½¬å‘`

  

## 1. Dockeræ˜¯ä»€ä¹ˆ?ä¸ºä»€ä¹ˆè¦ç”¨?

### DockeråŸºæœ¬æ¦‚å¿µ

ä¸Šé¢è¯´äº†ä¸€å †æµç¨‹,æœ€å¼€å§‹è€…è¦å…ˆç†è§£dockerçš„ä¸‰ä¸ªåŸºæœ¬æ¦‚å¿µ

-   **é•œåƒï¼ˆImageï¼‰ï¼š** Docker é•œåƒæ˜¯ä¸€ä¸ªåªè¯»çš„æ¨¡æ¿ï¼Œç”¨æ¥åˆ›å»ºå®¹å™¨,ç®€å•æ¥è¯´å°±æ˜¯ä¸º`å®¹å™¨`è¿è¡Œæä¾›éœ€è¦çš„ç¨‹åºã€èµ„æºã€é…ç½®ç­‰, ä»–åœ¨æ„å»ºæˆåŠŸåå°±ä¸ä¼šå˜åŒ–,åªç”¨äºå¯åŠ¨å®¹å™¨
-   **å®¹å™¨ï¼ˆContainerï¼‰ï¼š** å®¹å™¨æ˜¯é•œåƒçš„è¿è¡Œå®ä¾‹ï¼Œå¯ä»¥è¢«å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤ ,ä¸€ä¸ªDockeré•œåƒå¯ä»¥ä¾‹åŒ–å‡ºæ¥å¤šä¸ªå®¹å™¨ï¼Œæ¯ä¸ªå®¹å™¨ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ã€‚Dockerçš„å®¹å™¨æ˜¯ç”¨æ¥`è¿è¡Œç¨‹åºçš„,`å¯ä»¥ç†è§£ä¸ºDockerçš„å®¹å™¨å°±æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œç›®çš„æ˜¯è¿è¡Œæˆ‘ä»¬å†™çš„ç¨‹åºã€‚
-   **ä»“åº“ï¼ˆRepositoryï¼‰ï¼š** ç”¨æ¥å­˜å‚¨å’Œåˆ†å‘ Docker é•œåƒçš„åœ°æ–¹ [Dockerhub](https://hub.docker.com/) æœ‰ç‚¹ç±»ä¼¼äºgithubç”¨æˆ·å¯ä»¥åœ¨ä¸Šé¢æ‰˜ç®¡é•œåƒ

æ ¸å¿ƒæ¦‚å¿µå°±æ˜¯ï¼Œé€šè¿‡**Dockerfile**ç”Ÿæˆ`é•œåƒ`**æˆ–è€…ä»Dockerhub**ä¸­è·å–é•œåƒ ç„¶åå»åˆ›å»º`å®¹å™¨`,æœ€åè®©`ç¨‹åºè·‘åœ¨å®¹å™¨ä¸Š`ã€‚

ç†è§£äº†è¿™ä¸‰ä¸ªæ¦‚å¿µï¼Œå°±ç†è§£äº† **Docker** çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ

### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Docker

-   **ç¯å¢ƒä¸€è‡´æ€§:**  é¿å…å‘ç”Ÿåœ¨æˆ‘çš„ç”µè„‘ä¸Šèƒ½è¿è¡Œ,åˆ«äººçš„ç”µè„‘ä¸Šç”¨ä¸äº†çš„é—®é¢˜ï¼Œç¡®ä¿å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒçš„ä¸€è‡´æ€§
-   **ç‰ˆæœ¬éš”ç¦»ï¼š** åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šè¿è¡Œä¸åŒç‰ˆæœ¬çš„åº”ç”¨ï¼ˆå¦‚ä¸åŒç‰ˆæœ¬çš„Node.jsï¼‰ï¼Œé¿å…é¡¹ç›®æŠ¥é”™
-   **æœåŠ¡è¿ç§»ï¼š** å®¹å™¨åŒ–åçš„åº”ç”¨å¯ä»¥è½»æ¾åœ°åœ¨ä¸åŒæœåŠ¡å™¨é—´è¿ç§»ï¼Œæ— éœ€æ‹…å¿ƒç¯å¢ƒå·®å¼‚
-   **æ ‡å‡†åŒ–äº¤ä»˜ï¼š** æä¾›äº†ä¸€ä¸ªæ ‡å‡†çš„è½¯ä»¶äº¤ä»˜æ–¹å¼ï¼Œå‡å°‘äº†äººä¸ºéƒ¨ç½²é”™è¯¯

ä½¿ç”¨Dockerä¸ä»…èƒ½è§£å†³ä¼ ç»Ÿéƒ¨ç½²ä¸­çš„ç¯å¢ƒä¾èµ–é—®é¢˜ï¼Œè¿˜èƒ½å¤§å¤§æé«˜å¼€å‘å’Œéƒ¨ç½²æ•ˆç‡ã€‚å¦‚æœä½ ç®¡ç†å¤šä¸ªé¡¹ç›®ï¼ŒDockerèƒ½æ˜¾è‘—ç®€åŒ–ç»´æŠ¤å·¥ä½œï¼Œä½ æ€»ä¸æƒ³å› ä¸ºä¸åŒçš„ç¯å¢ƒ,ä¸åŒçš„ä¾èµ–å¯¼è‡´é—®é¢˜è€Œè‹¦æ¼å§.

å¯¹äºå‰ç«¯å¼€å‘çš„æ—¥å¸¸æ¥è¯´,åŸºæœ¬ç”¨ä¸åˆ°å®¹å™¨åŒ–, åŸºæœ¬çš„éƒ¨ç½²ä¹Ÿæ˜¯æ‰“ä¸ªdiståŒ…ç»™è¿ç»´(åç«¯)è®©ä»–ä»¬éƒ¨ç½²

**å‰ç«¯å¼€å‘ä¸æ‡‚å®¹å™¨åŒ–å¾ˆæ­£å¸¸ï¼Œä½†æ˜¯è‡³å°‘è¦è®©è‡ªå·±äº†è§£å®ƒã€‚**
## 2. ç¯å¢ƒæ­å»º

### Docker å®‰è£…

docker åˆ†ä¸º `stable` `test` å’Œ `nightly` ä¸‰ä¸ªæ›´æ–°é¢‘é“ã€‚å®˜æ–¹ç½‘ç«™ä¸Šæœ‰å„ç§ç¯å¢ƒä¸‹çš„ [å®‰è£…æŒ‡å—](https://docs.docker.com/get-docker/)ï¼Œ

æ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©å®‰è£…æ–¹å¼ï¼š

-   Linux å®‰è£…

    ```bash
    # Ubuntu
    sudo apt-get update
    sudo apt-get install docker-ce

    # CentOS
    sudo yum install docker-ce
    ```

-   Windows/Mac å®‰è£…

    ä¸‹è½½å¹¶å®‰è£… [Docker Desktop](https://www.docker.com/get-started/)ã€‚
    
å®‰è£…å®Œæˆåæ‰§è¡Œ`docker --version`éªŒè¯æ˜¯å¦æˆåŠŸ

![image1_eumu0v_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image1_eumu0v_.png)
å¦‚æœ `docker version`ã€`docker info` éƒ½æ­£å¸¸çš„è¯ï¼Œå¯ä»¥å°è¯•è¿è¡Œä¸€ä¸‹ [Nginx æœåŠ¡å™¨](https://hub.docker.com/_/nginx/)ï¼š
  
```bash
docker run -d -p 80:80 --name webserver nginx`
```
![image2_hmdjry_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image2_hmdjry_.png)

æœåŠ¡è¿è¡Œåï¼Œå¯ä»¥è®¿é—® [](http://localhost/)<http://localhost>ï¼Œå¦‚æœçœ‹åˆ°äº† "Welcome to nginx!"ï¼Œå°±è¯´æ˜åŸºç¡€ç¯å¢ƒéƒ½é…ç½®æˆåŠŸäº†ã€‚

![docker1_rq5jpm_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/docker1_rq5jpm_.png)

---

å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œæˆ–è€…é€šè¿‡Docker Desktopåœæ­¢ Nginx æœåŠ¡å™¨å¹¶åˆ é™¤æ‰§ï¼š

```bash
docker stop webserver 
docker rm webserver
```

![image3_tennup_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image3_tennup_.png)

å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°æ‹‰å– Docker é•œåƒååˆ†ç¼“æ…¢ï¼Œå¯ä»¥åœ¨ Docker Desktop é…ç½®å›½å†…é•œåƒåŠ é€Ÿã€‚

```js
"registry-mirrors":[
    "https://registry.docker-cn.com",
    "https://docker.mirrors.ustc.edu.cn",
    "http://hub-mirror.c.163.com"
]
```

![image4_zg2yvv_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image4_zg2yvv_.png)

## 3. å°†é¡¹ç›®å®¹å™¨åŒ–

### 3.1 æ„å»ºé•œåƒå‰å‡†å¤‡
é¦–å…ˆæ˜ç¡®2ä¸ªæ¦‚å¿µ

-   docker ä¸­å®¹å™¨(**Container**)åƒä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå®¹å™¨ä¸­è¿è¡Œç€ä¸€ä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿã€‚å¯ä»¥åœ¨å®¹å™¨ä¸­è£… Nodejs,mySqlç­‰,å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œç›¸å¯¹åº”çš„æ“ä½œ

-   é•œåƒ(**Image**)æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒæ˜¯ç”¨æ¥åˆ›å»ºå®¹å™¨çš„ã€‚ä»–é€šè¿‡æ‰§è¡ŒDockerfileæ–‡ä»¶è€Œæ¥

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å»ºç«‹3ä¸ªæ–‡ä»¶, åˆ†åˆ«ä¸º

-   `dockerfile` ç”¨äºé…ç½®dockeræ„å»ºä¿¡æ¯

```js
# ä½¿ç”¨ Node.js 16 ä½œä¸ºåŸºç¡€é•œåƒ
FROM node:16.14.2

# å°†å½“å‰å·¥ä½œç›®å½•è®¾ç½®ä¸º/app
WORKDIR /app

# å°† package.json å’Œ package-lock.json å¤åˆ¶åˆ° /app ç›®å½•ä¸‹
COPY package*.json ./

# è¿è¡Œ npm install å®‰è£…ä¾èµ–
RUN yarn install


# å°†æºä»£ç å¤åˆ¶åˆ° /app ç›®å½•ä¸‹
COPY . .

# æ‰“åŒ…æ„å»º
RUN npm run build

# å°†æ„å»ºåçš„ä»£ç å¤åˆ¶åˆ° nginx é•œåƒä¸­
FROM nginx:latest
COPY --from=0 /app/dist /usr/share/nginx/html

# å¤åˆ¶è‡ªå®šä¹‰çš„Nginxé…ç½®åˆ°é•œåƒä¸­ï¼Œè¦†ç›–é»˜è®¤é…ç½®
COPY nginx/default.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

# å¯åŠ¨ nginx æœåŠ¡
CMD ["nginx", "-g", "daemon off;"]
```


åªæœ‰Â `RUN`,Â `COPY`,Â `ADD`Â ä¼šåˆ›å»ºå±‚æ•°, å…¶å®ƒæŒ‡ä»¤ä¸ä¼šå¢åŠ é•œåƒçš„ä½“ç§¯

å¦‚æœæ˜¯æ„å»ºè¿‡ç¨‹ä¸­npmå› ä¸ºç½‘ç»œåŸå› ,å®‰è£…ä¾èµ–å¤±è´¥å¯ä»¥è€ƒè™‘ä½¿ç”¨ npmé•œåƒåœ°å€æˆ–è€…ä½¿ç”¨cnpm


```
# è¿è¡Œ npm install å®‰è£…cnpm å†é€šè¿‡cnpmå®‰è£…ä¾èµ– 
RUN npm -g --cache=none --registry https://registry.npmmirror.com \
 && cnpm install
```
-   `dockerignore` ä¸`.gitignore`Â è¯­æ³•ä¸€è‡´ã€‚ä½¿ç”¨å®ƒæ’é™¤æ„å»ºæ— å…³çš„æ–‡ä»¶åŠç›®å½•ï¼Œå¦‚Â `node_modules`
``` dockerignore
.DS_Store
node_modules
/dist


# local env files
.env.local
.env.*.local

# Log files
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Editor directories and files
.idea
.vscode
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
dist.zip
```

-   `nginx/default.conf` ç”¨äºè‡ªå®šä¹‰é…ç½®ngnixé…ç½®

```default.conf
server {
    listen 80;   # ç«¯å£å·æ˜¯80
    server_name localhost;
    
    location / {
        root   /usr/share/nginx/html;  # nginx é»˜è®¤ä¼šä»è¿™ä¸ªè·¯å¾„ä¸‹åŠ è½½ç½‘é¡µï¼Œè¿™æ˜¯ nginx é»˜è®¤çš„ç½‘é¡µæ ¹ç›®å½•
        index  index.html index.htm;
    }

    error_page  404              /404.html;  # é”™è¯¯404å¤„ç†
    error_page  500 502 503 504  /50x.html;  # é”™è¯¯5XXå¤„ç†

    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
```

### 3.2 é€šè¿‡ä½¿ç”¨docker buildå‘½ä»¤æ„å»ºå‰ç«¯é•œåƒ
ç¼–å†™å®Œæˆ3ä¸ªæ–‡ä»¶åå°±å¯ä»¥å¼€å§‹æ„å»ºäº†,æ‰§è¡Œä¸‹åˆ—å‘½ä»¤

```bash
docker build -t gyljr-admin:v1 .
```

è¿™é‡Œçš„`docker build -t` åé¢ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæˆ‘è‡ªå®šä¹‰çš„é¡¹ç›®å,ä½ ä¹Ÿå¯ä»¥éšä¾¿å–ä¸€ä¸ª,ç¬¬äºŒä¸ª:v1åˆ™ä»£è¡¨æ„å»ºçš„tag å¦‚æœé€šè¿‡è¿™ä¸ªæ¥åŒºåˆ†ä¸åŒç‰ˆæœ¬æ„å»º.æœ€åçš„.å·ä»£è¡¨ä¸Šä¸‹æ–‡è·¯å¾„ï¼Œ`docker` ä¼šåœ¨è¿™ä¸ªè·¯å¾„ä¸‹å¯»æ‰¾ `dockerfile` åŠå…¶ä»–æ–‡ä»¶ï¼Œæ ¹æ® `dockerfile` é…ç½®æ‰“é•œåƒã€‚


![image5_s0o6qm_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image5_s0o6qm_.png)

å¦‚æœæˆåŠŸæ‰“å‡ºäº†é•œåƒ,å¯ä»¥åœ¨æœ¬åœ°è¿è¡Œä¸€ä¸‹è¿™ä¸ªé•œåƒè¿›è¡ŒéªŒè¯

é€šè¿‡`docker run -d -p 3000:80 --name gyljr-admin-web gyljr-admin:v1` æ¥è¿è¡Œ

`3000:80`ä»£è¡¨æŠŠå®¿ä¸»æœºçš„ `3000` ç«¯å£è½¬å‘åˆ°å®¹å™¨çš„ `80` ç«¯å£ï¼Œ`gyljr-admin:v1`åˆ™æ˜¯æˆ‘ä»¬åˆšæ‰æ‰“å‡ºçš„é•œåƒçš„åå­—ã€‚


![image6_uh9snl_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image6_uh9snl_.png)

å¯ä»¥é€šè¿‡`docker ps` æˆ–è€…ç›´æ¥è®¿é—® <http://localhost:3000/> æ­¤æ—¶åº”è¯¥å¯ä»¥çœ‹åˆ° å‰ç«¯é™æ€é¡µé¢å·²ç»éƒ¨ç½²

è¿™æ—¶æˆ‘ä»¬å‘ç°ç½‘é¡µçš„æ¥å£è¯·æ±‚éƒ½ä¸º404,æ˜¯å› ä¸ºæˆ‘ä»¬åªéƒ¨ç½²äº†å‰ç«¯çš„é¡µé¢å’Œé™æ€èµ„æºè¿˜éœ€è¦éƒ¨ç½²åç«¯çš„æ¥å£æœåŠ¡


### 3.3 ç¼–å†™ç®€æ˜“nodeåç«¯æœåŠ¡

ç”±äºæˆ‘æ‰‹å¤´ä¸Šæ²¡æœ‰åˆé€‚çš„åç«¯æœåŠ¡,å¦‚æœæœ‰éœ€è¦å¯ä»¥å…ˆå®‰è£…dockeræ•°æ®åº“,å¼€å‘ç¯å¢ƒç­‰,å› æ­¤æˆ‘æ‰“ç®—ç”¨ä¸€ä¸ªç®€å•çš„nodeæœåŠ¡æ¥æ¨¡æ‹Ÿåç«¯æœåŠ¡

æ–°å»ºé¡¹ç›®æ–‡ä»¶å¤¹åæ‰§è¡Œ

```bash
npm i koa koa-router nodemon
```
åˆ›å»ºä¸€ä¸ªç®€å•çš„ Koa æœåŠ¡ä½œä¸ºç¤ºä¾‹ï¼š

```js
const Koa = require('koa');
const Router = require('koa-router');

const app = new Koa();
const router = new Router();

async function handleRequest(ctx) {
    try {
        ctx.body = {
            "code": 200,
            "status": 1,
            "message": "ok",
            "data": {
                "userRole": 1,
                "userId": "000000000000000001",
                "companyId": "1000000000000000001",
                "userName": "test",
            }
        }
    } catch(error) {
        ctx.status = 500;
        ctx.body = {
            error: 'Internal Server Error'
        };
    }
}

router.post('/Account/SignIn', async(ctx) = >{
    await handleRequest(ctx);
});


// ä½¿ç”¨è·¯ç”±ä¸­é—´ä»¶
app.use(router.routes());
app.use(router.allowedMethods());

// å¯åŠ¨æœåŠ¡å™¨
const port = 1000;
app.listen(port, () = >{
    console.log(`Server is running on port $ {
        port
    }`);
});
```
å¯ä»¥çœ‹åˆ°è¿™ä¸ªnode æœåŠ¡ä¸»è¦åŠŸèƒ½å°±æ˜¯æ¥å—ä¸€ä¸ªpostè¯·æ±‚ï¼Œæ¨¡æ‹Ÿè¯·æ±‚,æ¥å£è·¯å¾„æ˜¯`http://localhost:1000/Account/SignIn`

è¿™é‡Œå¯ä»¥æ ¹æ®ä½ é¡¹ç›®å®é™…æƒ…å†µä¿®æ”¹,åœ¨ä½ çš„å‰ç«¯é¡¹ç›®çš„è¯·æ±‚ä¸­,æ‰¾ä¸ªæ¥å£çš„è·¯å¾„åç§°å¤åˆ¶ä¸Šå»å³å¯, æˆ‘è¿™é‡Œæ˜¯ç”¨çš„ç™»é™†æ¥å£

ä¿®æ”¹è¯¥é¡¹ç›®`pack.json`

```js
{
  "type": "commonjs",
  "scripts": {
    "start": "nodemon app.js" //ä¸»è¦æ˜¯è¿™è¡Œ
  },
  "dependencies": {
    "koa": "^2.15.2",
    "koa-router": "^12.0.1"
  },
  "devDependencies": {
    "nodemon": "^3.1.9"
  }
}
```
è¿è¡Œ`node app.js`å‘ç°é¡¹ç›®æ­£å¸¸å¯åŠ¨,ä¸”ç”¨`postman`æˆ–å…¶ä»–æ¥å£å·¥å…·èƒ½å¤Ÿæ­£å¸¸è®¿é—®å³å¯å¼€å§‹æ„å»ºé•œåƒ

![image7_7i304k_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image7_7i304k_.png)

### 3.3 æ„å»ºnodeåç«¯æœåŠ¡é•œåƒ
- ç¼–å†™Dockerfileæ–‡ä»¶

```js
# æŒ‡å®šé•œåƒ
FROM node:16.14.2

# å¤åˆ¶æ–‡ä»¶åˆ°å®¹å™¨ä¸­ .å°±æ˜¯å½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶ã€‚ /appå°±æ˜¯å®¹å™¨çš„è·¯å¾„ï¼ˆè‡ªå®šä¹‰ï¼‰
ADD . /app  

# è¿›å…¥å·¥ä½œåŒºï¼ˆè·Ÿå¤åˆ¶çš„æ–‡ä»¶è·¯å¾„ä¸€è‡´ï¼‰
WORKDIR /app

# å®‰è£…ä¾èµ–
RUN npm install

# æš´éœ²ç«¯å£
EXPOSE 1000

# å¯åŠ¨æœåŠ¡
CMD ["node", "app.js"]
```

### 3.2 Docker é…ç½®ä¸æ„å»º

åˆ›å»ºdockerfile æ–‡ä»¶ï¼šè¿™é‡Œæˆ‘nodeæœåŠ¡å†™çš„æ¯”è¾ƒç®€å•åªéœ€è¦å®‰è£…ä¾èµ–å³å¯æ‰§è¡Œ,å¦‚æœæ¯”è¾ƒå¤æ‚çš„è¯éœ€è¦ä¿®æ”¹è¿™é‡Œé…ç½®

```js
# æŒ‡å®šåŸºç¡€é•œåƒ
FROM node:16.14.2

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
ADD . /app

# å®‰è£…ä¾èµ–
RUN npm install

# æš´éœ²ç«¯å£
EXPOSE 1000

# å¯åŠ¨æœåŠ¡
CMD ["node", "app.js"]
```

ä¹‹åä¸€æ ·çš„ å¯ä»¥é€šè¿‡å‘½ä»¤æ¥æ„å»ºé•œåƒ

```
docker build -t node_server:v1 .
```


![image8_b044fa_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image8_b044fa_.png)

![image9_pjeqvd_.jpeg](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image9_pjeqvd_.jpeg)

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„é•œåƒéƒ½å·²ç»æ„å»ºæˆåŠŸ,ä¹‹åæ‰§è¡Œä»£ç æ¥è¿è¡Œå®¹å™¨

```bash
docker run -d --name node_server_container -p 9000:1000 node_server:v1
```

![image10_k1obe3_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image10_k1obe3_.png)

### 4 Nginx åå‘ä»£ç†é…ç½®

```
 proxy: {
        '/api': {
          target: `http://xxx.xx.x.x:xxxx`, // åç«¯åœ°å€æœåŠ¡åœ°å€
          changeOrigin: true,
          secure: false,
          rewrite: (path) => path.replace(/^\/api/, ''),
        },
      }
 ```

æˆ‘ä»¬å¹³å¸¸å¼€å‘å‰ç«¯çš„é¡¹ç›®æ—¶,å¦‚æœè¯·æ±‚æœ¬åœ°çš„åç«¯åœ°å€,å®é™…ä¸Šæ˜¯`vite`æˆ–è€…`webpack`éƒ½ä¼šå¯åŠ¨ä¸€ä¸ªæœåŠ¡ç”¨äºè½¬å‘æˆ‘ä»¬çš„æ¥å£è·¯å¾„,ä»è€Œè¾¾åˆ°è§£å†³è·¨åŸŸé—®é¢˜çš„æ•ˆæœ,ä½†æ˜¯ç°åœ¨æ‰“åŒ…åå‰ç«¯é¡¹ç›®éƒ½æ˜¯é™æ€è€Œä¸”ä½äºdockerå®¹å™¨å†…è¯¥å¦‚ä½•è½¬å‘å‘¢?

æ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦å°†å‰ç«¯é¡µé¢çš„è¯·æ±‚é€šè¿‡`nginx`è½¬å‘åˆ°`node_server_containerè¿™`ä¸ªå®¹å™¨çš„ipå’Œç«¯å£ä¸‹

### 4.1 Dockerå®¹å™¨ip,ç«¯å£è·å–

å¯ä»¥é€šè¿‡`docker desktop`æŸ¥çœ‹ä¸€ä¸‹`node_server_container`çš„ip å‘½ä»¤è¡Œå¯ä»¥é€šè¿‡å…ˆç”¨`docker ps` è·å–å®¹å™¨idå `docker inspect å®¹å™¨id` è·å–ip

![image11_jwzraw_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image11_jwzraw_.png)

### 4.2 ä¿®æ”¹ngnixé…ç½®
çŸ¥é“äº†nodeæœåŠ¡ç«¯çš„ipå’Œç«¯å£æ¥ä¸‹æ¥åªè¦ä¿®æ”¹nginxé…ç½®å³å¯,è¿™æ—¶å€™å¯ä»¥ä¸ç”¨é‡æ–°æ‰“é•œåƒè€Œæ˜¯ç›´æ¥ä¿®æ”¹é•œåƒçš„ngnixé…ç½®

```
server {
    listen 80;   # ç«¯å£å·æ˜¯80
    server_name localhost;
    
    location / {
        root   /usr/share/nginx/html;  # nginx é»˜è®¤ä¼šä»è¿™ä¸ªè·¯å¾„ä¸‹åŠ è½½ç½‘é¡µï¼Œè¿™æ˜¯ nginx é»˜è®¤çš„ç½‘é¡µæ ¹ç›®å½•
        index  index.html index.htm;
    }
	  location /api/ {    
      rewrite  /api/(.*)  /$1  break;  # å¦‚æœéœ€è¦æŠŠè·¯å¾„/apiè·¯å¾„æ›¿æ¢ä¸º/åƒæˆ‘è¿™ä¸ªåç«¯æœåŠ¡ä¸­æ²¡æœ‰éœ€è¦æ›¿æ¢çš„è·¯å¾„è¿™é‡Œå…¶å®ç”¨ä¸åˆ°
      proxy_pass http://172.17.0.3:1000;
	  }

    location /Account/ { 
        proxy_pass http://172.17.0.3:1000;  # proxy_passï¼šå°±æ˜¯å¯¹åº”ä»£ç†åˆ°serverå®¹å™¨ä¸Šçš„åœ°å€ã€‚
    }

    error_page  404              /404.html;  # é”™è¯¯404å¤„ç†
    error_page  500 502 503 504  /50x.html;  # é”™è¯¯5XXå¤„ç†

    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
```

ä¿®æ”¹å®¹å™¨ngnixé…ç½®å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•

```bash
docker exec -it gyljr-admin-web bash
```

```bash
# ä¿®æ”¹é…ç½®æ–‡ä»¶
vi /etc/nginx/conf.d/default.conf
```

ç”¨viä¿®æ”¹å®Œæˆåï¼ŒæŒ‰`ESC` é”® è·³åˆ°å‘½ä»¤æ¨¡å¼ï¼Œç„¶åè¾“å…¥é€€å‡ºå‘½ä»¤`:wq` å³å¯ä¿å­˜æ–‡ä»¶å¹¶é€€å‡ºvi,ä¹‹åæ‰§è¡Œ 

```
# æµ‹è¯•é…ç½®æ˜¯å¦æ­£ç¡®
nginx -t

# é‡è½½é…ç½®ï¼ˆä¸åœæ­¢æœåŠ¡ï¼‰
nginx -s reload
```
---

å¦‚æœä½ dockerå†…æ²¡æœ‰vi é‚£å°±å…ˆå®‰è£…ä¸€ä¸ªæˆ–è€…ç›´æ¥æ”¹å‰ç«¯é¡¹ç›®çš„`nginx/default.conf`é…ç½®,ä¹‹åå†é‡æ–°æ‰“åŒ…ä¸€ä¸ªé•œåƒå³å¯,ä¸‹é¢æ˜¯å®¹å™¨å†…å®‰è£…viçš„æ–¹æ³•

æŸ¥çœ‹ç‰ˆæœ¬

```
cat /etc/os-release 
```

![image12_2eotm4_.png](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image12_2eotm4_.png)

```bash
# Debian/Ubuntu based

apt-get update
apt-get install vim

# Alpine based

apk add --no-cache vim
```
---
å¦‚æ­¤å®Œæˆ`ngnix`é…ç½®çš„ä¿®æ”¹åå†æ¬¡ç™»é™†å‰ç«¯é¡µé¢å¯ä»¥å‘ç°,é¡µé¢å·²ç»å¯ä»¥æ­£å¸¸è¯·æ±‚

![image13_5tpz48_.jpeg](https://cdn.jsdelivr.net/gh/czkm/img-folder@master/docker/image13_5tpz48_.jpeg)

### 4.3 å¸¸ç”¨ Docker å‘½ä»¤é€ŸæŸ¥

-   æ„å»ºé•œåƒï¼šdockerÂ build -t <é•œåƒå> .

-   è¿è¡Œå®¹å™¨ï¼šdocker run -p <æœ¬åœ°ç«¯å£>:<å®¹å™¨ç«¯å£> -d <é•œåƒå>

-   æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼šdockerÂ ps

-   åœæ­¢å®¹å™¨ï¼šdockerÂ stopÂ <å®¹å™¨ID>

-   åˆ é™¤å®¹å™¨ï¼šdocker rm <å®¹å™¨ID>

-   æŸ¥çœ‹é•œåƒåˆ—è¡¨ï¼šdocker images

-   åˆ é™¤é•œåƒï¼šdocker rmiÂ <é•œåƒID>

-   æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼šdocker logsÂ <å®¹å™¨ID>

-   è¿›å…¥å®¹å™¨å†…éƒ¨ï¼šdockerÂ exec -it <å®¹å™¨ID> /bin/bash

-   æŸ¥çœ‹å®¹å™¨å†…éƒ¨æ–‡ä»¶ï¼šdocker exec -itÂ <å®¹å™¨ID> ls

## åè®°

åœ¨æœ¬é¡¹ç›®ä¸­å­¦ä¹  docker çš„ä½¿ç”¨ï¼Œè¿˜å­¦ä¼šäº†å¦‚ä½•ä½¿ç”¨ docker åˆ¶ä½œé•œåƒã€è¿è¡Œå®¹å™¨, å…¶å®è¿˜å¯ä»¥åšè‡ªåŠ¨åŒ–CI/CD é…ç½®ï¼Œä»è€Œå®ç°ä»£ç æäº¤æˆ–è€…æ›´æ–° è‡ªåŠ¨åŒ–æ„å»ºç„¶åå‘å¸ƒ,è¿™ä¸ªå¯ä»¥ç•™ä¸ªå‘åç»­å†åšåˆ†äº«ã€‚

æœ€åçš„æœ€å,æœ¬ç€å¹´åº•æ€»å¾—æŠ˜è…¾ç‚¹å•¥çš„å¿ƒæ€å†™äº†è¿™ç¯‡æ–‡ç« ,å¦‚æœæœ‰é”™è¯¯æˆ–è€…ä¸è¶³å¸Œæœ›å„ä½æŒ‡æ­£

2024å¹´å·²ç»æ¥åˆ°å°¾å£°,å¸Œæœ›çœ‹åˆ°è¿™é‡Œçš„ä½ 2025å¹´èƒ½å¤Ÿå¥åº·é¡ºé‚! æ–°å¹´å¿«ä¹ğŸ‰
